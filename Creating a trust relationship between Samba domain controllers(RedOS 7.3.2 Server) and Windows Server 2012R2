Creating a trust relationship between Samba domain controllers(RedOS 7.3.2 Server) and Windows Server 2012R2
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
План действий:
1) Создать контроллер домена на ОС Windows Server 2012R2;
2) Создать контроллер домена на ОС Linux RedOS 7.3.2 Server;
3) Подготовить контроллер домена на ОС Windows Server 2012R2 для создания доверительных отношений с контроллером домена на ОС Linux RedOS 7.3.2 Server;
4) Подготовить контроллер домена на ОС Linux RedOS 7.3.2 Server для создания доверительных отношений с контроллером домена на ОС Windows Server 2012R2;
5) Создать доверительные отношения.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
Адресация уже настроенной ВМ с ОС Windows Server 2012R2
Hostname: dcd.domenok.ru
IP-address: 10.10.10.222
Mask: 255.255.255.0
Gateway: 10.10.10.253
DNS: 127.0.0.1
------------
Адресация уже настроенной ВМ с ОС RedOS 7.3.2 Server
Hostname: dcc.cir.ru
IP-address: 10.10.10.111
Mask: 255.255.255.0
Gateway: 10.10.10.253
DNS: 10.10.10.111
DNS: 10.10.10.222
Поисковый домен: domenok.ru
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
Предисловие:
------------
КД - контроллер домена
------------
Nano - это консольный текстовый редактор для UNIX и Unix-подобных операционных систем, основанный на библиотеке curses и распространяемый под лицензией 
GNU GPL.
------------
Samba4 - это многофункциональный серверный продукт, предоставляющий как реализацию файлового сервера, сервиса печати, так и сервера идентификации(winbind).
------------
Winbind - это демон («служба» в терминах Windows), работающий на клиентах Samba и действующий как прокси для связи между PAM и NSS, работающими на 
компьютере Linux, с одной стороны, и Active Directory, работающей на контроллере домена, с другой.
------------
NMTUI - это инструмент командной строки, который используется для настройки сети в системах Gnu / Linux. При запуске он вызывает графический текстовый 
интерфейс, который помогает пользователям легко и эффективно настраивать сетевые интерфейсы.
------------
Active Directory (AD) — это службы каталогов корпорации Microsoft для операционных систем семейства Windows Server. С помощью AD можно объединить различные 
объекты сети (серверы, принтеры и различные сервисы) в единую систему, наладить удобный поиск и использование необходимых данных.
------------
Сервер - это компьютер, выполняющий определённые роли в домене.
------------
Контроллер домена - это сервер, хранящий каталог и обслуживающий запросы пользователей к каталогу. Помимо хранения данных контроллер домена может выступать 
в качестве одной из FSMO-ролей.
------------
Домен - это минимальная структурная единица организации Active Directory(может состоять из пользователей, компьютеров, принтеров, прочих общих ресурсов).
------------
Дерево доменов - это иерархическая система доменов, имеющая единый корень(корневой домен).
------------
Лес доменов - это множество деревьев доменов, находящихся в различных формах доверительных отношений.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
1) Ни для кого не секрет, как настраивается ВМ с ОС Windows Server 2012R2 и как поднимается контроллер домена. И для того, чтобы не захламлять интсрукцию,
я предпочту не рассказывать о том, как настраивается ВМ с ОС Windows Server 2012R2.
Но вот что нужно знать при создании КД. КД должен быть с таким функционалом:
------------
1 - Forest functional level: Windows Server 2008R2;
2 - Domain functional level: Windows Server 2008R2.
------------
Если создадите с другим функционалом, то работать ничего не будет.
ТАКЖЕ!!! Не забудьте добавить обратные DNS-зоны.
В моём примере обратная DNS-зона будет выглядеть следующим образом: 10.10.10.in-addr.arpa
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
https://redos.red-soft.ru/base/server-configuring/domain-config/install-samba-dc/
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
2) При создании ВМ минимально рекомендуется выделить: Sockets: 2; Cores: 2; Memory(MiB): 8192.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
После установки рабочей станции, обязательно нужно прописать статику. После того, как статическая адресация будет прописана, нужно будет перезагрузить
сетевой интерфейс:
------------
ifdown ens18 && ifup ens18 |#|#| Перезапуск сетевого интерфейса.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
yum update -y && yum upgrade -y |#|#| Поиск и обновление пакетов.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
reboot |#|#| Перезагрузка системы.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
yum install samba-client*.x86_64 samba-common.noarch samba-common*x86_64 samba-dc*.x86_64 samba-libs*.x86_64 samba-winbind*.x86_64 -y |#|#| Установка необходимых пакетов
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
smbd -b | grep HAVE_LIBKADM5SRV_MIT |#|#| Проверка Samba на наличие Kerberos Heimdal. Если команда выдаёт "HAVE_LIBKADM5SRV_MIT", тогда нужно установить Samba с  поддержкой Kerberos Heimdal.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
mv /etc/krb5.conf /etc/krb5.conf.bak |#|#| Переименование дефолтного файла Kerberos.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
mv /etc/samba/smb.conf /etc/samba/smb.conf.bak |#|#| Переименование дефолтного файла Samba.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
smbd -V |#|#| Команда проверки установленной версии Samba.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/selinux/config |#|#| В файле config нужно поменять статус SElinux. Заменить текст SELINUX=enforcing на SELINUX=permissive.
setenforce 0
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
hostnamectl set-hostname dcc.cir.ru |#|#| Смена имени сервера.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/hosts |#|#| В файле hosts нужно добавить ниже IP-адрес сервера, его полное и короткое имя.
Пример: 10.10.10.111 dcc.cir.cu dcc
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
systemctl restart NetworkManager |#|#| Перезагразка сетевого интерфейса.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
cat /etc/resolv.conf |#|#| Проверка файла resolv.conf в прописанными dns-адресами.
Вывод должнен быть таким:
# Generated by NetworkManager
search cir.ru
nameserver 77.88.8.88
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool domain provision --use-rfc2307 --interactive |#|#| Запуск конфигурирования Samba в роли контроллера домена в интерактивном режиме.

Realm [CIR.RU]:
Domain [CIR]:
Server Role (dc, member, standalone) [dc]: dc
DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]:
DNS forwarder IP address (write 'none' to disable forwarding) [77.88.8.88]: 10.10.10.111
Administrator password:
Retype password:
INFO 2023-02-03 12:55:46,492 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2108: Looking up IPv4 addresses
INFO 2023-02-03 12:55:46,494 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2125: Looking up IPv6 addresses
WARNING 2023-02-03 12:55:46,495 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2132: No IPv6 address will be assigned
INFO 2023-02-03 12:55:46,755 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2274: Setting up share.ldb
INFO 2023-02-03 12:55:46,771 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2278: Setting up secrets.ldb
INFO 2023-02-03 12:55:46,783 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2283: Setting up the registry
INFO 2023-02-03 12:55:46,825 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2286: Setting up the privileges database
INFO 2023-02-03 12:55:46,847 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2289: Setting up idmap db
INFO 2023-02-03 12:55:46,862 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2296: Setting up SAM db
INFO 2023-02-03 12:55:46,867 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #880: Setting up sam.ldb partitions and settings
INFO 2023-02-03 12:55:46,868 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #892: Setting up sam.ldb rootDSE
INFO 2023-02-03 12:55:46,871 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1305: Pre-loading the Samba 4 and AD schema
Unable to determine the DomainSID, can not enforce uniqueness constraint on local domainSIDs

INFO 2023-02-03 12:55:46,909 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1383: Adding DomainDN: DC=cir,DC=ru
INFO 2023-02-03 12:55:46,922 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1415: Adding configuration container
INFO 2023-02-03 12:55:46,933 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1430: Setting up sam.ldb schema
INFO 2023-02-03 12:55:49,421 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1448: Setting up sam.ldb configuration data
INFO 2023-02-03 12:55:49,554 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1489: Setting up display specifiers
INFO 2023-02-03 12:55:51,254 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1497: Modifying display specifiers and extended rights
INFO 2023-02-03 12:55:51,287 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1504: Adding users container
INFO 2023-02-03 12:55:51,288 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1510: Modifying users container
INFO 2023-02-03 12:55:51,289 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1513: Adding computers container
INFO 2023-02-03 12:55:51,290 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1519: Modifying computers container
INFO 2023-02-03 12:55:51,291 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1523: Setting up sam.ldb data
INFO 2023-02-03 12:55:51,397 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1553: Setting up well known security principals
INFO 2023-02-03 12:55:51,435 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1567: Setting up sam.ldb users and groups
INFO 2023-02-03 12:55:51,552 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #1575: Setting up self join
Repacking database from v1 to v2 format (first record CN=ms-SPP-Installation-Id,CN=Schema,CN=Configuration,DC=cir,DC=ru)
Repack: re-packed 10000 records so far
Repacking database from v1 to v2 format (first record CN=interSiteTransport-Display,CN=C04,CN=DisplaySpecifiers,CN=Configuration,DC=cir,DC=ru)
Repacking database from v1 to v2 format (first record CN=ipsecNFA{59319BE2-5EE3-11D2-ACE8-0060B0ECCA17},CN=IP Security,CN=System,DC=cir,DC=ru)
INFO 2023-02-03 12:55:52,602 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/sambadns.py #1200: Adding DNS accounts
INFO 2023-02-03 12:55:52,619 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/sambadns.py #1234: Creating CN=MicrosoftDNS,CN=System,DC=cir,DC=ru
INFO 2023-02-03 12:55:52,634 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/sambadns.py #1247: Creating DomainDnsZones and ForestDnsZones partitions
INFO 2023-02-03 12:55:52,677 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/sambadns.py #1252: Populating DomainDnsZones and ForestDnsZones partitions
Repacking database from v1 to v2 format (first record DC=j.root-servers.net,DC=RootDNSServers,CN=MicrosoftDNS,DC=DomainDnsZones,DC=cir,DC=ru)
Repacking database from v1 to v2 format (first record DC=_kerberos._tcp.Default-First-Site-Name._sites.dc,DC=_msdcs.cir.ru,CN=MicrosoftDNS,DC=ForestDnsZones,DC=cir,DC=ru)
INFO 2023-02-03 12:55:52,849 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2012: Setting up sam.ldb rootDSE marking as synchronized
INFO 2023-02-03 12:55:52,852 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2017: Fixing provision GUIDs
INFO 2023-02-03 12:55:53,923 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2348: A Kerberos configuration suitable for Samba AD has been generated at /var/lib/samba/private/krb5.conf
INFO 2023-02-03 12:55:53,923 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2350: Merge the contents of this file with your system krb5.conf or replace it with this one. Do not create a symlink!
INFO 2023-02-03 12:55:53,967 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #2082: Setting up fake yp server settings
INFO 2023-02-03 12:55:54,024 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #487: Once the above files are installed, your Samba AD server will be ready to use
INFO 2023-02-03 12:55:54,024 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #492: Server Role:           active directory domain controller
INFO 2023-02-03 12:55:54,024 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #493: Hostname:              dcc
INFO 2023-02-03 12:55:54,024 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #494: NetBIOS Domain:        CIR
INFO 2023-02-03 12:55:54,024 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #495: DNS Domain:            cir.ru
INFO 2023-02-03 12:55:54,024 pid:4043 /usr/lib64/python3.8/site-packages/samba/provision/__init__.py #496: DOMAIN SID:            S-1-5-21-25273870-955602320-113037211
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
После окончания конфигурирования контроллера домена, нужно зайти в настройки сетевого интерфейса и встроке "Серверы DNS" поменять адрес 77.88.8.88 на 10.10.10.111.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/samba/smb.conf |#|#| В файле smb.conf, раздел [global] нужно привести к следующему виду:
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
[global]
log level = 3
dns forwarder = 10.10.10.111
netbios name = DCC
realm= CIR.RU
server role = active directory domain controller
workgroup= CIR
idmap_ldb:use rfc2307 = yes
vfs objects = dfs_samba4 acl_xattr
map acl inherit = yes
store dos attributes = yes
allow dns updates = nonsecure
nsupdate command = /usr/bin/nsupdate -g
dsdb:schema update allowed = true

[netlogon]
path = /var/lib/samba/sysvol/cir.ru/scripts
read only = No 

[sysvol]
path = /var/lib/samba/sysvol
read only = No
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
testparm |#|#| Команда для проверки работоспособности файла "smb.conf" в каталоге "/etc/samba/"
При хорошем раскладе вывод должен быть таким: 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
Load smb config files fr om /etc/samba/smb.conf
Loaded services file OK.
Weak crypto is allowed
Server role: ROLE_ACTIVE_DIRECTORY_DC
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
cp /var/lib/samba/private/krb5.conf /etc/ |#|#| Копирование сконфигурированного файла Kerberos.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/krb5.conf |#|#| Файл нужно привести к следующему виду:
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
[libdefaults]
default_realm = CIR.RU
dns_lookup_realm = false
dns_lookup_kdc = true
ticket_lifetime = 24h
forwardable = yes

[realms]
CIR.RU = {
  default_domain = cir.ru
}

[domain_realm]
  dcc = CIR.RU
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
systemctl status samba.service |#|#| Проверка статуса Samba.
systemctl start samba.service |#|#| Запуск службы Samba.
systemctl enable samba.service --now |#|#| Добавление в автозапуск сервиса Samba
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
reboot |#|#| Перезапуск системы
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
ping ya.ru |#|#| Команда проверки dns
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
ps ax | egrep "samba|smbd|nmbd|winbindd" |#|#| Команда проверки запущенных процессов
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
wbinfo --ping-dc |#|#| Команда для проверки подключения службы Winbind к контроллеру домена
При упешном подключении Winbind 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
wbinfo -u |#|#| Команда для показа доменных пользователей
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
wbinfo -g |#|#| Команда для показа доменных групп
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
yum install -y redadm |#|#| Команда для установки Web-интерфейса, для управления для управления доменом Samba
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/redadm/server.conf |#|#| Команда для настройки конфигурационного файла Samba-сервера
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
Пример настройки конфигурационного файла:
-----------------------------------------
[SETTINGS]
name= cir.ru |#|#| Имя вашего домена
ldap_url= ldaps://10.10.10.111:636 |#|#| ldaps-адрес к нужному контроллеру домена, в нашем случае это Samba DC
cert_path= /etc/pki/ca-trust/source/anchors/ca.pem |#|#| адрес сертификата TLS(SSL) (создается автоматически при установке, можете указать свой)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/redadm/client.conf
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
[SETTINGS]
IP=10.10.10.111 |#|#| IP-адрес вашего сервера RedAdm, к которому будут подключаться клиенты
PORT=8989 |#|#| Порт, к которому будут подключаться клиенты РЕД АДМ
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
systemctl enable redadm.service redis.service redadm-celery-worker.service redadm-celery-beat.service --now |#|#| Команда для добавления в автозагрузку
сервисов ПО RedAdm
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
systemctl restart redadm
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
Вход осуществляется с помощью доменной учетной записи Linux RedOS 7.3.2 Workstation
Ссылка для входа: http://ip-address:8989
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
