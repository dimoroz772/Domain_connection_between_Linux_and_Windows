Развертывание вторичного контроллера домена на ОС RedOS 7.3.2 Server GUI с использованием Samba4 в уже созданном домене на Windows Server 2012R2
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Все описанные ниже действия выполнялись под пользователем root
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Всем привет! Для реализации данного проекта мне потребовалось:
1) Создать ВМ с ОС Windows Server 2012R2 и обновить данную ОС до последней версии;
2) Прописать статическую адресацию на ВМ с ОС Windows Server 2012R2 и поменять имя сервера;
3) Установить роль "Active Directory" на ВМ с ОС Windows Server 2012R2;
4) На ВМ с ОС Windows Server 2012R2 повысить роль сервера до уровня контроллера домена;
5) Добавить обратные зоны в DNS-сервере на ВМ ОС Windows Server 2012R2;
6) Создать ВМ с ОС RedOS 7.3.2 Server GUI и обновить данную ОС до последней версии;
7) Установить набор необходимых пакетов на ОС RedOS 7.3.2 Server GUI;
8) Прописать статическую адресацию на ОС RedOS 7.3.2 Server GUI и поменять имя сервера;
9) Выполнить преднастройку конфигурационных файлов на ОС RedOS 7.3.2 Server GUI перед подключением к домену на Windows Server 2012R2$
10) Выполнить подключение ОС RedOS 7.3.2 Server GUI к Windows Server 2012R2 как вторичный контроллер домена 
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Адресация уже настроенной ВМ с ОС Windows Server 2012R2
Hostname: dc2.domenok.ru
IP-address: 10.10.10.222
Mask:255.255.255.0
Gateway: 10.10.10.253
DNS: 127.0.0.1
DNS: 10.10.10.111
------------
Адресация уже настроенной ВМ с ОС RedOS 7.3.2 Server GUI
Hostname: dc1.domenok.ru
IP-address: 10.10.10.111
Mask: 255.255.255.0
Gateway: 10.10.10.253
DNS: 10.10.10.111
DNS: 10.10.10.222
Поисковый домен: domenok.ru
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Предисловие:
------------
КД - контроллер домена
------------
Nano - это консольный текстовый редактор для UNIX и Unix-подобных операционных систем, основанный на библиотеке curses и распространяемый под лицензией 
GNU GPL.
------------
Samba4 - это многофункциональный серверный продукт, предоставляющий как реализацию файлового сервера, сервиса печати, так и сервера идентификации(winbind).
------------
Winbind - это демон («служба» в терминах Windows), работающий на клиентах Samba и действующий как прокси для связи между PAM и NSS, работающими на 
компьютере Linux, с одной стороны, и Active Directory, работающей на контроллере домена, с другой.
------------
NMTUI - это инструмент командной строки, который используется для настройки сети в системах Gnu / Linux. При запуске он вызывает графический текстовый 
интерфейс, который помогает пользователям легко и эффективно настраивать сетевые интерфейсы.
------------
Active Directory (AD) — это службы каталогов корпорации Microsoft для операционных систем семейства Windows Server. С помощью AD можно объединить различные 
объекты сети (серверы, принтеры и различные сервисы) в единую систему, наладить удобный поиск и использование необходимых данных.
------------
Сервер - это компьютер, выполняющий определённые роли в домене.
------------
Контроллер домена - это сервер, хранящий каталог и обслуживающий запросы пользователей к каталогу. Помимо хранения данных контроллер домена может выступать 
в качестве одной из FSMO-ролей.
------------
Домен - это минимальная структурная единица организации Active Directory(может состоять из пользователей, компьютеров, принтеров, прочих общих ресурсов).
------------
Дерево доменов - это иерархическая система доменов, имеющая единый корень(корневой домен).
------------
Лес доменов - это множество деревьев доменов, находящихся в различных формах доверительных отношений.
-----------------------------------------------------------------------------------------------------------------------------------------------------------
1-5) Ни для кого не секрет, как настраивается ВМ с ОС Windows Server 2012R2 и как поднимается контроллер домена. И для того, чтобы не захламлять интсрукцию,
я предпочту не рассказывать о том, как настраивается ВМ с ОС Windows Server 2012R2.
Но вот что нужно знать при создании КД. КД должен быть с таким функционалом:
------------
1 - Forest functional level: Windows Server 2008R2;
2 - Domain functional level: Windows Server 2008R2.
------------
Если создадите с другим функционалом, то работать ничего не будет.
ТАКЖЕ!!! Не забудьте добавить обратные DNS-зоны.
В моём примере обратная DNS-зона будет выглядеть следующим образом: 10.10.10.in-addr.arpa
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Переходим к настройке ВМ с ОС RedOS 7.3.2 Server GUI
-----------------------------------------------------------------------------------------------------------------------------------------------------------
6) Перед началом выполнения каких-либо манипуляций, нужно выполнить подготовку ОС RedOS 7.3.2 Server GUI. Для начала обновим пакеты системы.
-----------------------------------------------------------------------------------------------------------------------------------------------------------
yum update -y && yum upgrade -y |#|#| Поиск и обновление пакетов системы
-----------------------------------------------------------------------------------------------------------------------------------------------------------
reboot |#|#| Команда для перезагрузки сервера
-----------------------------------------------------------------------------------------------------------------------------------------------------------
7) Установка необходимых пакетов/компонентов.
-----------------------------------------------------------------------------------------------------------------------------------------------------------
yum install samba-client*.x86_64 samba-common.noarch samba-common*x86_64 samba-dc*.x86_64 samba-libs*.x86_64 samba-winbind*.x86_64 -y |#|#| Команда для 
установки небходимых пакетов, которые понадобятся для сборки КД на Samba4
-----------------------------------------------------------------------------------------------------------------------------------------------------------
smbd -b | grep HAVE_LIBKADM5SRV_MIT |#|#| Если следующая команда выдаёт "HAVE_LIBKADM5SRV_MIT", тогда нужно установить Samba с  поддержкой Kerberos Heimdal.
-----------------------------------------------------------------------------------------------------------------------------------------------------------
yum install -y redadm |#|#| Команда для установки пакета с ПО RedAdm, для управления КД Samba4
-----------------------------------------------------------------------------------------------------------------------------------------------------------
8) Также для избежания потери связи с сервером, нужно позаботиться о статической IP-адресации. Статическую адресацию можно прописать с помощью инструмента
командной строки nmtui.
-----------------------------------------------------------------------------------------------------------------------------------------------------------
yum install -y NetworkManager-tui |#|#| Команда для установки пакета NMTUI, если вдруг его не окажется на сервере
------------
Гайд по тому, как пользоваться инструментом nmtui, вы можете посмотреть в интернете.
-----------------------------------------------------------------------------------------------------------------------------------------------------------
После настройки статической IP-адресации, измените имя сервера. Это можно сделать через NMTUI, либо командой.
------------
hostnamectl set-hostname dc1.domenok.ru
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Следующим шагом укажите адрес первичного КД в файле "hosts", который лежит в каталоге "/etc/"
------------
10.10.10.222 dc2.domenok.ru dc2
-----------------------------------------------------------------------------------------------------------------------------------------------------------
systemctl restart NetworkManager |#|#| Команда для применения настроек на сетевом интерфейсе
-----------------------------------------------------------------------------------------------------------------------------------------------------------
cat /etc/resolv.conf |#|#| Команда для проверки файла "resolv.conf"
------------
В консоли должно отображаться следующее
# Generated by NetworkManager
search domenok.ru
nameserver 10.10.10.222
-----------------------------------------------------------------------------------------------------------------------------------------------------------
9) Подготовка конфигурационных файлов перед присоединением к домену "domenok.ru"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
mv /etc/krb5.conf /etc/krb5.conf.bak |#|#| Команда для переименования используемого по умолчанию конфигурационного файла samba
-----------------------------------------------------------------------------------------------------------------------------------------------------------
mv /etc/samba/smb.conf /etc/samba/smb.conf.bak |#|#| Команда для переименования используемого по умолчанию конфигурационного файла kerberos
-----------------------------------------------------------------------------------------------------------------------------------------------------------
smbd -V |#|#| Команда для проверки установленной версии samba
-----------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/selinux/config |#|#| Команда для редактирования конфигурационного файла "config" в каталоге "/etc/selinux/"
------------
Нужно заменить текст SELINUX=enforcing на SELINUX=permissive
------------
setenforce 0 |#|#| Команда для временного отключения selinux
-----------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/redadm/server.conf |#|#| Команда для редактирования конфигурационного файла "server.conf" расположенного в каталоге "/etc/redadm/"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Данный конфигурационный файл нужно привести к следующему виду:
------------
[SETTINGS]
name= domenok.ru # имя вашего домена
ldap_url = ldaps://10.10.10.111:636 # ldaps-адрес к нужному контроллеру домена
cert_path = /etc/pki/ca-trust/source/anchors/ca.pem # адрес сертификата TLS(SSL) (создается автоматически при установке, можете указать свой)
-----------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/redadm/client.conf |#|#| Команда для редактирования конфигурационного файла "client.conf" расположенного в каталоге "/etc/redadm/"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Данный конфигурационный файл нужно привести к следующему виду:
------------
[SETTINGS]
IP=10.10.10.111 # IP-адрес вашего сервера РЕД АДМ, по которому будут подключаться клиенты
PORT=8989 # порт, к которому будут подключаться клиенты РЕД АДМ
-----------------------------------------------------------------------------------------------------------------------------------------------------------
10) После всех произведенных настроек, можно приступать к подключению сервера, к контроллеру домена "domenok.ru" на ВМ с ОС Windows Server 2012R2
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool domain join domenok.ru DC -U"domenok\Администратор" |#|#| Команда для подключения ВМ с ОС RedOS 7.3.2 Server GUI, к ВМ с ОС Windows Server 2012R2
как контроллер домена.
-----------------------------------------------------------------------------------------------------------------------------------------------------------
reboot |#|#| Команда для перезапуска сервера
-----------------------------------------------------------------------------------------------------------------------------------------------------------
После того, ВМ с ОС RedOS 7.3.2 Server GUI стала КД домена "domenok.ru", можно приступать к конечному конфигурированию конфигурационных файлов smb.conf and
krb5.conf
-----------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/samba/smb.conf |#|#| Команда для редактирования файла smb.conf, который находится к каталоге "/etc/samba/"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Данный конфигурационный файл нужно привести к следующему виду:
------------
# Global parameters
[global]
        log level = 3
        dns forwarder = 10.10.10.222
        netbios name = DC1
        realm = DOMENOK.RU
        server role = active directory domain controller
        workgroup = DOMENOK
        idmap_ldb:use rfc2307 = yes
        vfs objects = dfs_samba4 acl_xattr
        map acl inherit = yes
        store dos attributes = yes
        allow dns updates = nonsecure
        nsupdate command = /usr/bin/nsupdate -g
        dsdb:schema update allowed = true
        security = user
        map to guest = bad user
        wins support = no
        dns proxy = no

[sysvol]
        path = /var/lib/samba/sysvol
        read only = No

[netlogon]
	path = /var/lib/samba/sysvol/domenok.ru/scripts
        read only = No

[public]
        path = /samba/public
        guest ok = yes
        force user = nobody
        browsable = yes
        writable = yes

[private]
	path = /samba/private
        valid users = @smbgrp
        guest ok = no
        browsable = yes
        writable = yes
-----------------------------------------------------------------------------------------------------------------------------------------------------------
testparm |#|#| Команда для проверки внесения изменений в файл "smb.conf", находящегося к каталоге "/etc/samba/"
------------
Если конфигурация файла прописана без ошибок, то после выполнения команды получится следующий вывод:
------------
Load smb config files fr om /etc/samba/smb.conf
Loaded services file OK.
Weak crypto is allowed
Server role: ROLE_ACTIVE_DIRECTORY_DC
-----------------------------------------------------------------------------------------------------------------------------------------------------------
nano /etc/krb5.conf |#|#| Команда для редактирования файла krb5.conf, который находится к каталоге "/etc/"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Данный конфигурационный файл нужно привести к следующему виду:
------------
[libdefaults]
	default_realm = DOMENOK.RU
        dns_lookup_realm = true
        dns_lookup_kdc = true
        ticket_lifetime = 24h
        forwardable = yes
        default_tgs_enctypes = arcfour-hmac-md5 des-cbc-crc des-cbc-md5
        default_tkt_enctypes = arcfour-hmac-md5 des-cbc-crc des-cbc-md5

[realms]
DOMENOK.RU = {
	default_domain = DOMENOK.RU
        kdc = DC1.DOMENOK.RU:88
        admin_server = DC1.DOMENOK.RU
}

[domain_realm]
	DC1 = DOMENOK.RU
-----------------------------------------------------------------------------------------------------------------------------------------------------------
systemctl enable samba --now |#|#| Команда для добавления в автозапуск сервиса "samba"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
systemctl status samba |#|#| Команда для запуска сервиса "samba"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
ping ya.ru |#|#| Команда для проверки dns-а
-----------------------------------------------------------------------------------------------------------------------------------------------------------
ps ax | egrep "samba|smbd|nmbd|winbindd" |#|#| Команда для проверки запущенных процессов
-----------------------------------------------------------------------------------------------------------------------------------------------------------
wbinfo --ping-dc |#|#| Команда для проверки подключение службы Winbindd к контроллеру домена
------------
Если все собрано без ошибок, то при выполнении данной команды выведется подобный ответ:
------------
checking the NETLOGON for domain[DOMENOK] dc connection to "DC1.DOMENOK.RU" succeeded
-----------------------------------------------------------------------------------------------------------------------------------------------------------
wbinfo -u |#|#| Команда для вывода списка доменных пользователей
-----------------------------------------------------------------------------------------------------------------------------------------------------------
wbinfo -g |#|#| Команда для вывода списка доменных групп
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool user list |#|#| Команда для вывода списка доменных пользователей
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool user create Larry |#|#| Команда для создания доменного пользователя "Larry"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool user delete Larry |#|#| Команда для удаления доменного пользователя "Larry"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool user setpassword Larry |#|#| Команда для смены пароля доменного пользователя "Larry"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool user disable Larry |#|#| Команда для отключения доменного пользователя "Larry"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool group list |#|#| Команда для вывода списка доменных групп
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool group add Tester |#|#| Команда для создания доменной группы "Tester"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool group delete Tester |#|#| Команда для удаления доменной группы "Tester"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool group addmembers Tester Larry |#|#| Команда для добавления пользователя "Larry" в группу "Tester"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool group removemembers Tester Larry |#|#| Команда для удаления пользователя "Larry" из группы "Tester"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool dns zonecreate -U Администратор dc1.domenok.ru 10.10.10.in-addr.arpa |#|#| Команда для добавления обратной зоны "10.10.10.in-addr.arpa"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
samba-tool dns zonecreate -U Администратор dc1.domenok.ru 0.in-addr.arpa |#|#| Команда для добавления обратной зоны "0.in-addr.arpa"
samba-tool dns zonecreate -U Администратор dc1.domenok.ru 127.in-addr.arpa |#|#| Команда для добавления обратной зоны "127.in-addr.arpa"
samba-tool dns zonecreate -U Администратор dc1.domenok.ru 255.in-addr.arpa |#|#| Команда для добавления обратной зоны "255.in-addr.arpa"
-----------------------------------------------------------------------------------------------------------------------------------------------------------
systemctl restart samba.service |#|#| Команда для перезагрузки сервиса samba
-----------------------------------------------------------------------------------------------------------------------------------------------------------
После настройки сервера, можно и познакомиться с Web-интерфейсом для управления КД Samba DC. Для того, чтобы зайти на Web-интерфейс, нужно в поисковой 
строке браузера вписать следующее:
------------
http://10.10.10.111:8989
------------
Вместо 10.10.10.111 укажите свой адрес сервера
------------
После того, как открылась страница логирования, следующим шагом нужно ввести учётные данные администратора домена и после входа должнен появится Dashboard
ПО RedAdm.
-----------------------------------------------------------------------------------------------------------------------------------------------------------
На этом инструкция завершена! Спасибо за внимание)
